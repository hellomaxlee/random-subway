<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Random NYC Subway Stop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --card:#11162a; --muted:#aab1c7; --text:#e7ecf7; --accent:#7aa2ff; --border:#222a45;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0a0f1f, #0f1630 40%, #0a1025);
      color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:820px;margin:48px auto;padding:0 20px}
    header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px}
    h1{margin:0;font-weight:800;letter-spacing:.2px}
    .tag{color:var(--muted);font-size:.95rem}
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    fieldset{border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin:0}
    legend{font-size:.9rem;color:var(--muted); padding:0 .4rem}
    .boroughs{display:flex; gap:14px; flex-wrap:wrap; padding:6px 2px}
    label{display:inline-flex; gap:.5rem; align-items:center; cursor:pointer; user-select:none}
    input[type="checkbox"]{width:18px;height:18px}
    .controls{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:14px}
    button{
      font-weight:700; padding:.7rem 1.1rem; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg,#1b2350,#17204a); color:#fff; cursor:pointer;
    }
    button:hover{filter:brightness(1.07)}
    .result{margin-top:18px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px 18px;
    }
    .muted{color:var(--muted)}
    .name{font-size:1.4rem;font-weight:800;letter-spacing:.2px;margin:.3rem 0}
    .row{display:flex; gap:18px; align-items:center; flex-wrap:wrap}
    .lines{display:flex; gap:8px; flex-wrap:wrap}
    .dot{
      width:28px;height:28px;border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
      font-weight:800; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.4); border:1px solid rgba(0,0,0,.35);
    }
    .footer{margin-top:14px;color:var(--muted);font-size:.9rem}
    .count{color:var(--accent);font-weight:700}
    .error{color:#ff8e8e}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üé≤ Random NYC Subway Stop</h1>
        <div class="tag">NY Open Data ‚ÄúMTA Subway Stations &amp; Complexes‚Äù</div>
      </div>
      <div class="tag">Loaded: <span id="count" class="count">0</span></div>
    </header>

    <section class="panel">
      <fieldset>
        <legend>Boroughs</legend>
        <div class="boroughs">
          <label><input type="checkbox" name="borough" value="Manhattan" checked>Manhattan</label>
          <label><input type="checkbox" name="borough" value="Brooklyn" checked>Brooklyn</label>
          <label><input type="checkbox" name="borough" value="Queens" checked>Queens</label>
          <label><input type="checkbox" name="borough" value="Bronx" checked>Bronx</label>
          <label><input type="checkbox" name="borough" value="Staten Island" checked>Staten Island</label>
        </div>
      </fieldset>
      <div class="controls">
        <button id="pickBtn">Pick a station</button>
        <div id="status" class="muted">Loading stations‚Ä¶</div>
      </div>
      <div class="result">
        <div id="result" class="card muted">Click ‚ÄúPick a station‚Äù to draw a stop.</div>
      </div>
      <div class="footer">
        Tip: Add a <code>stations.json</code> file to this repo for a fully static, super-fast site.
      </div>
    </section>
  </div>

<script>
(async function(){
  // ---------- CONFIG ----------
  const LOCAL_JSON = './stations.json'; // optional: drop a file with that name into the repo
  const SOCRATA_URL = 'https://data.ny.gov/resource/5f5g-n3cz.json';
  const SELECT = 'complex_name,station_name,borough,services,latitude,longitude';
  const LIMIT = 5000;
  const APP_TOKEN = ''; // paste your Socrata App Token here (optional but recommended)
  // ----------------------------

  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');
  const countEl = document.getElementById('count');
  const btn = document.getElementById('pickBtn');

  // MTA line colors
  const LINE_COLORS = {
    '1':'#EE352E','2':'#EE352E','3':'#EE352E',
    '4':'#00933C','5':'#00933C','6':'#00933C','6X':'#00933C',
    '7':'#B933AD','7X':'#B933AD',
    'A':'#0039A6','C':'#0039A6','E':'#0039A6',
    'B':'#FF6319','D':'#FF6319','F':'#FF6319','M':'#FF6319',
    'G':'#6CBE45',
    'J':'#996633','Z':'#996633',
    'L':'#A7A9AC',
    'N':'#FCCC0A','Q':'#FCCC0A','R':'#FCCC0A','W':'#FCCC0A',
    'S':'#808183','SIR':'#0039A6'
  };

  const FALLBACK = [
    { complex_name: 'Times Sq - 42 St', borough: 'Manhattan', services: '1 2 3 7 N Q R W S', latitude: 40.7553, longitude: -73.9871 },
    { complex_name: 'Atlantic Av - Barclays Ctr', borough: 'Brooklyn', services: 'B Q 2 3 4 5 D N R', latitude: 40.6844, longitude: -73.9780 },
    { complex_name: 'Flushing - Main St', borough: 'Queens', services: '7', latitude: 40.7597, longitude: -73.8300 },
    { complex_name: '149 St - Grand Concourse', borough: 'Bronx', services: '2 5', latitude: 40.8184, longitude: -73.9278 },
    { complex_name: 'St George', borough: 'Staten Island', services: 'SIR', latitude: 40.6437, longitude: -74.0732 }
  ];

  let stations = [];

  function splitLines(s){
    const raw = s.services || s.lines || s.transfers || s.routes || '';
    return Array.isArray(raw) ? raw : (typeof raw === 'string' ? raw.split(/[,\s/]+/).filter(Boolean) : []);
  }

  function dotHTML(code){
    const c = (code || '').toUpperCase();
    const col = LINE_COLORS[c] || '#555';
    // Keep 1-character labels centered; render 'SIR' as text
    const label = c.length <= 2 ? c : '‚Ä¢';
    return `<span class="dot" style="background:${col}">${label}</span>`;
  }

  function renderStation(s){
    const name = s.complex_name || s.station_name || s.name || 'Unknown';
    const borough = s.borough || '‚Äî';
    const lines = splitLines(s);

    resultEl.innerHTML = `
      <div class="row">
        <div>
          <div class="muted">Borough</div>
          <div><strong>${borough}</strong></div>
        </div>
        <div>
          <div class="muted">Lines</div>
          <div class="lines">${lines.length ? lines.map(dotHTML).join('') : '<span class="muted">‚Äî</span>'}</div>
        </div>
      </div>
      <div class="name">${name}</div>
    `;
  }

  function selectedBoroughs(){
    return [...document.querySelectorAll('input[name="borough"]:checked')].map(cb => cb.value);
  }

  function pickRandom(list){ return list[Math.floor(Math.random() * list.length)]; }

  function pickAndShow(){
    if (!stations.length){ return; }
    const sel = selectedBoroughs();
    const pool = sel.length ? stations.filter(s => sel.includes(s.borough)) : stations;
    if (!pool.length){
      resultEl.innerHTML = `<span class="error">No stations match your filter.</span>`;
      return;
    }
    renderStation(pickRandom(pool));
  }
  btn.addEventListener('click', pickAndShow);

  async function fetchWithTimeout(url, opts={}, ms=9000){
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), ms);
    try { return await fetch(url, { ...opts, signal: ctrl.signal }); }
    finally { clearTimeout(id); }
  }

  // Load order: local stations.json ‚Üí Socrata API ‚Üí fallback
  statusEl.textContent = 'Loading stations‚Ä¶';
  try {
    // 1) Local file (if present)
    const localRes = await fetchWithTimeout(LOCAL_JSON, {}, 2500);
    if (localRes.ok){
      const local = await localRes.json();
      if (Array.isArray(local) && local.length){
        stations = local;
        statusEl.textContent = 'Loaded from stations.json';
      }
    }
  } catch(_) { /* ignore */ }

  if (!stations.length){
    try {
      // 2) Live API
      const qs = new URLSearchParams({
        '$select': SELECT,
        '$limit': String(LIMIT),
      });
      if (APP_TOKEN) qs.set('$$app_token', APP_TOKEN); // query param token
      const url = `${SOCRATA_URL}?${qs.toString()}`;
      const headers = APP_TOKEN ? { 'X-App-Token': APP_TOKEN } : {};
      const res = await fetchWithTimeout(url, { headers }, 9000);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const data = await res.json();
      stations = data.filter(s => (s.complex_name || s.station_name) && s.borough);
      statusEl.textContent = `Loaded ${stations.length} stations from API`;
    } catch(e){
      console.error('API fetch failed:', e);
    }
  }

  if (!stations.length){
    // 3) Fallback
    stations = FALLBACK;
    statusEl.innerHTML = `<span class="error">Using small fallback set (add an App Token or stations.json)</span>`;
  }

  countEl.textContent = String(stations.length);
})();
</script>
</body>
</html>
