<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Random NYC Subway Stop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafbfe; --ink:#0f1222; --muted:#6a7086; --card:#ffffff; --border:#e6e9f2; --accent:#2b59ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.55;
    }
    .wrap{max-width:880px;margin:48px auto;padding:0 20px}
    header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:18px}
    h1{margin:0; font-weight:800; letter-spacing:.2px; font-size:1.8rem}
    .tag{color:var(--muted); font-size:.95rem}
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 8px 30px rgba(23,27,59,.06);
    }
    fieldset{border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin:0}
    legend{font-size:.9rem;color:var(--muted); padding:0 .4rem}
    .boroughs{display:flex; gap:16px; flex-wrap:wrap; padding:6px 2px}
    label{display:inline-flex; gap:.5rem; align-items:center; cursor:pointer; user-select:none}
    input[type="checkbox"]{width:18px;height:18px}
    .controls{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:14px}
    button{
      font-weight:700; padding:.7rem 1.1rem; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg,#f4f6ff,#e8edff); color:#0b1a64; cursor:pointer;
    }
    button:hover{filter:brightness(1.02)}
    .status{color:var(--muted)}
    .notice{color:#c41e3a; font-weight:600}
    .result{margin-top:18px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px 18px;
    }
    .name{font-size:1.35rem;font-weight:800;letter-spacing:.2px;margin:.3rem 0 .1rem}
    .row{display:flex; gap:18px; align-items:center; flex-wrap:wrap}
    .group{min-width:180px}
    .label{color:var(--muted); font-size:.9rem}
    .lines{display:flex; gap:8px; flex-wrap:wrap}
    .dot{
      width:28px;height:28px;border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
      font-weight:800; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.35); border:1px solid rgba(0,0,0,.15);
      font-size:.95rem;
    }
    .count{color:var(--accent);font-weight:700}
    footer{margin-top:10px; color:var(--muted); font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Random NYC Subway Stop</h1>
        <div class="tag">Data source: NY Open Data “MTA Subway Stations &amp; Complexes” (static CSV)</div>
      </div>
      <div class="tag">Loaded: <span id="count" class="count">0</span></div>
    </header>

    <section class="panel">
      <fieldset>
        <legend>Boroughs</legend>
        <div class="boroughs">
          <label><input type="checkbox" name="borough" value="Manhattan" checked>Manhattan</label>
          <label><input type="checkbox" name="borough" value="Brooklyn" checked>Brooklyn</label>
          <label><input type="checkbox" name="borough" value="Queens" checked>Queens</label>
          <label><input type="checkbox" name="borough" value="Bronx" checked>Bronx</label>
          <label><input type="checkbox" name="borough" value="Staten Island" checked>Staten Island</label>
        </div>
      </fieldset>

      <div class="controls">
        <button id="pickBtn">Pick a station</button>
        <div id="status" class="status">Loading stations…</div>
      </div>

      <div class="result">
        <div id="result" class="card status">Click “Pick a station” to draw a stop.</div>
      </div>

      <footer>
        Tip: This page reads <code>stations.csv</code> from the site root. No external API calls.
      </footer>
    </section>
  </div>

  <!-- Robust CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
(function(){
  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');
  const countEl = document.getElementById('count');
  const btn = document.getElementById('pickBtn');

  // MTA line colors
  const LINE_COLORS = {
    '1':'#EE352E','2':'#EE352E','3':'#EE352E',
    '4':'#00933C','5':'#00933C','6':'#00933C','6X':'#00933C',
    '7':'#B933AD','7X':'#B933AD',
    'A':'#0039A6','C':'#0039A6','E':'#0039A6',
    'B':'#FF6319','D':'#FF6319','F':'#FF6319','M':'#FF6319',
    'G':'#6CBE45',
    'J':'#996633','Z':'#996633',
    'L':'#A7A9AC',
    'N':'#FCCC0A','Q':'#FCCC0A','R':'#FCCC0A','W':'#FCCC0A',
    'S':'#808183','SIR':'#0039A6'
  };

  // tiny fallback in case CSV is missing
  const FALLBACK = [
    { complex_name: 'Times Sq - 42 St', borough: 'Manhattan', services: '1 2 3 7 N Q R W S' },
    { complex_name: 'Atlantic Av - Barclays Ctr', borough: 'Brooklyn', services: 'B Q 2 3 4 5 D N R' },
    { complex_name: 'Flushing - Main St', borough: 'Queens', services: '7' },
    { complex_name: '149 St - Grand Concourse', borough: 'Bronx', services: '2 5' },
    { complex_name: 'St George', borough: 'Staten Island', services: 'SIR' }
  ];

  let stations = [];

  // Try to find a column by any of several likely names (case-insensitive)
  function getField(row, candidates){
    for (const key of Object.keys(row)){
      const k = key.trim().toLowerCase();
      for (const c of candidates){
        if (k === c) return row[key];
      }
    }
    return undefined;
  }

  function normName(row){
    return getField(row, ['complex_name','complex','complexname']) ||
           getField(row, ['station_name','stop_name','name','station']);
  }

  function normBorough(row){
    return getField(row, ['borough','boro']);
  }

  function normServices(row){
    return getField(row, ['services','lines','route','routes','transfers']);
  }

  function normLat(row){
    return getField(row, ['latitude','lat','gtfs_latitude','y']);
  }

  function normLon(row){
    return getField(row, ['longitude','lon','long','gtfs_longitude','x']);
  }

  function splitLines(s){
    if (!s) return [];
    if (Array.isArray(s)) return s;
    return String(s).split(/[,\s/]+/).filter(Boolean);
  }

  function dotHTML(code){
    const c = (code || '').toUpperCase();
    const col = LINE_COLORS[c] || '#555';
    const label = c.length <= 3 ? c : '•';
    return `<span class="dot" style="background:${col}">${label}</span>`;
  }

  function renderStation(s){
    const name = s.name || 'Unknown';
    const borough = s.borough || '—';
    const lines = splitLines(s.services);

    resultEl.classList.remove('status');
    resultEl.innerHTML = `
      <div class="row">
        <div class="group">
          <div class="label">Borough</div>
          <div><strong>${borough}</strong></div>
        </div>
        <div class="group">
          <div class="label">Lines</div>
          <div class="lines">${lines.length ? lines.map(dotHTML).join('') : '<span class="label">—</span>'}</div>
        </div>
      </div>
      <div class="name">${name}</div>
    `;
  }

  function selectedBoroughs(){
    return [...document.querySelectorAll('input[name="borough"]:checked')].map(cb => cb.value);
  }

  function pickRandom(list){ return list[Math.floor(Math.random() * list.length)]; }

  function pickAndShow(){
    if (!stations.length){ return; }
    const sel = selectedBoroughs();
    const pool = sel.length ? stations.filter(s => sel.includes(s.borough)) : stations;
    if (!pool.length){
      resultEl.classList.add('status');
      resultEl.textContent = 'No stations match your filter.';
      return;
    }
    renderStation(pickRandom(pool));
  }

  btn.addEventListener('click', pickAndShow);

  function mapRow(row){
    const name = normName(row);
    const borough = normBorough(row);
    const services = normServices(row);
    const lat = normLat(row);
    const lon = normLon(row);
    return (name && borough) ? { name, borough, services, latitude: lat, longitude: lon } : null;
  }

  function loadCSV(){
    statusEl.textContent = 'Loading stations.csv…';
    Papa.parse('./stations.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      fastMode: false,
      complete: (res) => {
        const mapped = res.data.map(mapRow).filter(Boolean);
        if (mapped.length){
          stations = mapped;
          countEl.textContent = String(stations.length);
          statusEl.textContent = 'Loaded from stations.csv';
        } else {
          stations = FALLBACK;
          countEl.textContent = String(stations.length);
          statusEl.innerHTML = '<span class="notice">stations.csv parsed but no usable rows — using small fallback set.</span>';
        }
      },
      error: (err) => {
        stations = FALLBACK;
        countEl.textContent = String(stations.length);
        statusEl.innerHTML = `<span class="notice">Could not load stations.csv — using small fallback set. (${err && err.message ? err.message : 'Unknown error'})</span>`;
      }
    });
  }

  loadCSV();
})();
</script>
</body>
</html>
