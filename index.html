<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Random NYC Subway Stop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .wrap { max-width: 720px; }
    h1 { margin: 0 0 .5rem; }
    .muted { color: #666; }
    .small { font-size: .9rem; }
    .controls { display: grid; gap: .75rem; align-items: center; margin: 1rem 0; }
    fieldset { border: 1px solid #e6e6e6; border-radius: .75rem; padding: .5rem .75rem; }
    .boroughs { display: flex; gap: 1rem; flex-wrap: wrap; }
    label { display: inline-flex; gap: .4rem; align-items: center; }
    button { font-size: 1rem; padding: .6rem .9rem; border-radius: .6rem; border: 1px solid #ccc; cursor: pointer; width: fit-content; }
    .card { border: 1px solid #e6e6e6; border-radius: 1rem; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .lines { display: inline-flex; gap: .35rem; flex-wrap: wrap; margin-left: .25rem; vertical-align: middle; }
    .pill { padding: .2rem .5rem; border-radius: .75rem; border: 1px solid #ddd; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üé≤ Random NYC Subway Stop</h1>
    <div class="muted small">Data: NY Open Data ‚ÄúMTA Subway Stations &amp; Complexes‚Äù (with offline fallback)</div>

    <div class="controls">
      <fieldset>
        <legend class="small muted">Boroughs</legend>
        <div class="boroughs">
          <label><input type="checkbox" name="borough" value="Manhattan" checked>Manhattan</label>
          <label><input type="checkbox" name="borough" value="Brooklyn" checked>Brooklyn</label>
          <label><input type="checkbox" name="borough" value="Queens" checked>Queens</label>
          <label><input type="checkbox" name="borough" value="Bronx" checked>Bronx</label>
          <label><input type="checkbox" name="borough" value="Staten Island" checked>Staten Island</label>
        </div>
      </fieldset>
      <button id="pickBtn">Pick a station</button>
    </div>

    <div id="result" class="card muted">Loading stations‚Ä¶</div>
  </div>

<script>
(async function () {
  // === CONFIG ===
  const DATASET = 'https://data.ny.gov/resource/5f5g-n3cz.json';
  const LIMIT = 5000;
  // Optional: add your Socrata app token here to avoid rate limits
  // Get one free at data.ny.gov (Developer ‚Üí App Tokens)
  const APP_TOKEN = ''; // e.g., 'abcdEFGH123456789'
  // =================

  const resultEl = document.getElementById('result');
  const btn = document.getElementById('pickBtn');

  // Small offline fallback so the UI still works if fetch fails
  const FALLBACK = [
    { complex_name: 'Times Sq - 42 St', borough: 'Manhattan', services: '1 2 3 7 N Q R W S', latitude: 40.7553, longitude: -73.9871 },
    { complex_name: 'Atlantic Av - Barclays Ctr', borough: 'Brooklyn', services: 'B Q 2 3 4 5 D N R', latitude: 40.6844, longitude: -73.9780 },
    { complex_name: 'Flushing - Main St', borough: 'Queens', services: '7', latitude: 40.7597, longitude: -73.8300 },
    { complex_name: '149 St - Grand Concourse', borough: 'Bronx', services: '2 5', latitude: 40.8184, longitude: -73.9278 },
    { complex_name: 'St George', borough: 'Staten Island', services: 'SIR', latitude: 40.6437, longitude: -74.0732 }
  ];

  let stations = [];

  function splitLines(s) {
    const raw = s.services || s.lines || s.transfers || s.routes || '';
    return Array.isArray(raw) ? raw
      : (typeof raw === 'string' ? raw.split(/[,\s/]+/).filter(Boolean) : []);
  }

  function renderStation(s) {
    const name = s.complex_name || s.station_name || s.stop_name || s.name || 'Unknown';
    const borough = s.borough || '‚Äî';
    const lat = parseFloat(s.latitude || (s.location && s.location.latitude) || s?.the_geom?.coordinates?.[1]);
    const lon = parseFloat(s.longitude || (s.location && s.location.longitude) || s?.the_geom?.coordinates?.[0]);
    const lines = splitLines(s);

    const mapsHref = (!isNaN(lat) && !isNaN(lon))
      ? `https://www.google.com/maps?q=${lat},${lon} (${encodeURIComponent(name)})`
      : `https://www.google.com/maps/search/${encodeURIComponent(name + ' subway station NYC')}`;

    resultEl.innerHTML = `
      <div>
        <div class="small muted">Borough</div>
        <div><strong>${borough}</strong></div>
      </div>
      <div style="height:.75rem"></div>
      <div class="small muted">Station / Complex</div>
      <div style="font-size:1.25rem; font-weight:700; line-height:1.3">${name}</div>
      <div style="height:.5rem"></div>
      <div class="small muted">Lines</div>
      <div class="lines">${lines.length ? lines.map(l => `<span class="pill">${l}</span>`).join('') : '<span class="muted">‚Äî</span>'}</div>
      <div style="height:.75rem"></div>
      <a href="${mapsHref}" target="_blank" rel="noopener">Open in Google Maps ‚Üó</a>
    `;
  }

  function selectedBoroughs() {
    return [...document.querySelectorAll('input[name="borough"]:checked')].map(cb => cb.value);
  }

  function pickRandom(list) {
    return list[Math.floor(Math.random() * list.length)];
  }

  function pickAndShow() {
    if (!stations.length) return;
    const sel = selectedBoroughs();
    const pool = sel.length ? stations.filter(s => sel.includes(s.borough)) : stations;
    if (!pool.length) {
      resultEl.textContent = `No stations match your filter.`;
      return;
    }
    renderStation(pickRandom(pool));
  }

  btn.addEventListener('click', pickAndShow);

  // Fetch stations
  resultEl.textContent = 'Loading stations‚Ä¶';
  try {
    const params =
      `?$select=complex_name,station_name,borough,services,latitude,longitude&$limit=${LIMIT}`;
    const url = DATASET + params;
    const opts = APP_TOKEN ? { headers: { 'X-App-Token': APP_TOKEN } } : undefined;

    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const data = await res.json();

    stations = data.filter(s => (s.complex_name || s.station_name) && s.borough);
    if (!stations.length) throw new Error('No stations returned');

    resultEl.textContent = `Loaded ${stations.length} stations. Click ‚ÄúPick a station‚Äù.`;
  } catch (err) {
    console.error('Station load failed:', err);
    stations = FALLBACK;
    resultEl.innerHTML = `Couldn‚Äôt reach NY Open Data (using fallback sample). Click ‚ÄúPick a station‚Äù to test the app.`;
  }
})();
</script>
</body>
</html>
